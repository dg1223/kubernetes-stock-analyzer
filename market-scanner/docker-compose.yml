services:
  redis:
    image: redis:7
    command: ["redis-server", "--requirepass", "/run/secrets/redis_password"]
    secrets:
      - redis_password
    ports:
      - "6379:6379"

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: marketdata
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    ports:
      - "5432:5432"

  premarket:
    build:
      context: .
      dockerfile: services/premarket/Dockerfile
    secrets:
      - alphavantage_api_key
      - redis_password
    volumes:
      - ./input/tickers.txt:/input/tickers.txt
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379

  pricefetcher:
    build:
      context: .
      dockerfile: services/pricefetcher/Dockerfile
    secrets:
      - alphavantage_api_key
      - redis_password
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379

  coordinator:
    build:
      context: .
      dockerfile: services/coordinator/Dockerfile
    secrets:
      - redis_password
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379

  alertdispatcher:
    build:
      context: .
      dockerfile: services/alertdispatcher/Dockerfile
    secrets:
      - redis_password
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379

secrets:
  alphavantage_api_key:
    file: ./secrets/alphavantage_api_key.txt
  redis_password:
    file: ./secrets/redis_password.txt
  postgres_password:
    file: ./secrets/postgres_password.txt
